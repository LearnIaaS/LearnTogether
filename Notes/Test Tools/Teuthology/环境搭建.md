# Teuthology

## 执行流程

- Teuthology framework 的工作流程大致是这样的，首先通过scheduler节点生成需要测试suite的jobs，放到Beanstalk队列中，然后由worker节点从队列中取出任务，并在slave nodes上去执行。

### scheduler生成jobs流程

teuthology 生成关于具体test suites的jobs是通过teuthology-suite命令执行的，一般在 ./teuthology/virtualenv/bin/ 目录下面。

运行 suite：

```shell
$ teuthology-suite -s <suite> [-c <ceph>] [-k <kernel>] [-e email] [-f flavor] [-t <teuth>] [-m <mtype>]
```

参数含义：

```
- suite: the name of the suite (the directory in ceph-qa-suite).
- ceph: ceph branch to be used.
- kernel: version of the kernel to be used.
- email: email address to send the results to.
- flavor: the kernel flavor to run against
- teuth: version of teuthology to run
- mtype: machine type of the run
- templates: template file used for further modifying the suite (optional)
```

-m 机器类型和 -s suite名字必须指定。

一个更具体的例子：

```shell
$ teuthology-suite -s rbd -c wip-fix -k jewel -e bob.smith@foo.com -f basic -t jewel -m mira
```

上面的例子运行rbd suite使用ceph wip-fix分支，jewel内核，basic 内核flavor，teuthology的jewel分支。它会运行在mira的机器上，生成任务结束后会发送邮件到bob.smith@foo.com。

### Teuthology框架

- cpeh-cm-ansible
- ceph-qa-suite
- ceph\aq\workunits
- teuthology

#### cpeh-cm-ansible

ansible 是基于模块工作的。ansible 本身没有批量部署的能力，真正具有批量部署的是 ansible 所运行的模块。ansible 只是提供一种框架。框架包括：

- 连接插件 connection plugins 负责和被监控端实现通信
- Host Inventory：指定操作的主机，是一个配置文件里面定义监控的主机
- 各种模块，核心模块，command模块，自定义模块
- 借助于插件完成记录日志邮件等功能
- PlayBooks：剧本执行多个任务时。并非必需，可以让节点一次性运行多个任务

#### ceph-qa-suite

- 测试脚本库
- 包括 yaml 文件和 python 脚本

#### workunits

- 路径：ceph\aq\workunits
- 主要为 shell 脚本文件
- 可在 yaml 文件中调用
- 与 ceph-qa-suite 配合完成测试

## teuthology 任务

- 1个 run 包含多个job，1个job包含多个 tasks
- 提交一个 suite，可生成多个 job，使用 teuthology-suite 提交一个 run
- teuthology 管理者提交 run 到 Beanstalked 队列中
- teuthworker 执行者从 Beanstalkd 队列中去 job 执行，并在 pulpito 页面显示运行状态。执行完成后将日志生成到指定目录下，并将数据推送到 pulpito 页面显示













[teuthology 执行流程(1)](https://blog.csdn.net/shansni/article/details/53820967)

[Install teuthology on centos 6.5](https://www.cnblogs.com/AlfredChen/p/3904554.html)

[teuthology安裝部署（2）](https://www.itread01.com/content/1550603712.html)

# 其他知识补充

## 什么是Ceph

Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。

[Ceph介绍及原理架构分享](https://www.jianshu.com/p/cc3ece850433)